<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="me._hanho.nextjs_shop.buy.BuyMapper">

	<select id="selectAllActiveHoldsByUser">
		SELECT *
		FROM nextjs_shop_stock_hold
		WHERE user_id = #{userId} AND status = 'HOLD' AND active_hold = 1 
	</select>
	
 <!-- 전역 가용수량: stock - sum(HOLD & 미만료) -->
  <select id="selectAvailability" resultType="me._hanho.nextjs_shop.buy.AvailabilityRow">
	  SELECT
	    pd.product_option_id,
	    GREATEST(
	      pd.stock - IFNULL(SUM(
	        CASE
	          WHEN sh.status = 'HOLD'
	           AND sh.active_hold = 1
	           AND sh.expires_at > NOW()
	          THEN sh.count
	          ELSE 0
	        END
	      ), 0),
	      0
	    ) AS available
	  FROM nextjs_shop_product_option pd
	  LEFT JOIN nextjs_shop_stock_hold sh
	    ON sh.product_option_id = pd.product_option_id
	  WHERE pd.product_option_id IN
	    <foreach collection="detailIds" item="id" open="(" separator="," close=")">
	      #{id}
	    </foreach>
	  GROUP BY pd.product_option_id
  </select>

  <!-- 본인 미만료 HOLD -->
  <select id="selectExistingHolds" resultType="me._hanho.nextjs_shop.buy.ExistingHold">
    SELECT hold_id, product_option_id, count
    FROM nextjs_shop_stock_hold
    WHERE user_id = #{userId}
      AND status = 'HOLD'
      AND expires_at > NOW()
      AND product_option_id IN
        <foreach collection="detailIds" item="id" open="(" separator="," close=")">
          #{id}
        </foreach>
  </select>

  <!-- 멱등 업서트: 유니크(UQ_user_pd_status) 충돌 시 count/TTL 갱신 -->
  <insert id="upsertHolds">
	  INSERT INTO nextjs_shop_stock_hold
	    (user_id, product_option_id, count, status, active_hold, expires_at, created_at)
	  VALUES
	    <foreach collection="rows" item="r" separator=",">
	      (#{r.userId}, #{r.productOptionId}, #{r.count},
	       'HOLD', 1,
	       DATE_ADD(NOW(), INTERVAL #{r.ttlSeconds} SECOND), NOW())
	    </foreach>
	  ON DUPLICATE KEY UPDATE
	    count = VALUES(count),
	    expires_at = DATE_ADD(NOW(), INTERVAL #{rows[0].ttlSeconds} SECOND),
	    status = 'HOLD',
	    active_hold = 1
  </insert>

  <!-- ↑ MySQL에서 VALUES(expires_at) 사용 불가 이슈 회피:
       expires_at를 직접 다시 계산해서 갱신 -->
  <insert id="upsertHolds" databaseId="mysql">
    INSERT INTO nextjs_shop_stock_hold
      (user_id, product_option_id, count, status, expires_at, created_at)
    VALUES
      <foreach collection="rows" item="r" separator=",">
        (#{r.userId}, #{r.productOptionId}, #{r.count}, 'HOLD',
         DATE_ADD(NOW(), INTERVAL #{r.ttlSeconds} SECOND), NOW())
      </foreach>
    ON DUPLICATE KEY UPDATE
      count = VALUES(count),
      expires_at = DATE_ADD(NOW(), INTERVAL
        <choose>
          <when test="rows != null and rows.size() == 1">
            #{rows[0].ttlSeconds}
          </when>
          <otherwise>
            180
          </otherwise>
        </choose>
        SECOND)
  </insert>

  <!-- 최신 HOLD (유저+pdId별 1건) -->
  <select id="selectLatestHolds" resultType="me._hanho.nextjs_shop.buy.HoldBrief">
    SELECT t.product_option_id, t.hold_id
    FROM nextjs_shop_stock_hold t
    INNER JOIN (
      SELECT product_option_id, MAX(hold_id) AS max_id
      FROM nextjs_shop_stock_hold
      WHERE user_id = #{userId}
        AND product_option_id IN
          <foreach collection="detailIds" item="id" open="(" separator="," close=")">
            #{id}
          </foreach>
        AND status = 'HOLD'
      GROUP BY product_option_id
    ) m ON m.max_id = t.hold_id
  </select>
  
    <!-- 점유 연장: 활성(HOLD & active_hold=1) 인 것만 NOW()+TTL 로 갱신 -->
  <update id="extendHolds">
    UPDATE nextjs_shop_stock_hold
    SET expires_at = DATE_ADD(NOW(), INTERVAL #{ttlSeconds} SECOND)
    WHERE status = 'HOLD'
      AND active_hold = 1
      AND hold_id IN
      <foreach collection="holdIds" item="id" open="(" separator="," close=")">
        #{id}
      </foreach>
  </update>

  <!-- 점유 해제: 활성(HOLD & active_hold=1) → RELEASED, active_hold=NULL -->
  <update id="releaseHolds">
    UPDATE nextjs_shop_stock_hold
    SET status = 'RELEASED',
        active_hold = NULL
    WHERE status = 'HOLD'
      AND active_hold = 1
      AND hold_id IN
      <foreach collection="holdIds" item="id" open="(" separator="," close=")">
        #{id}
      </foreach>
  </update>
  
   <!-- 점유하고 있는 상품조회 -->
  <select id="getOrderStock">
  	SELECT sh.hold_id, sh.count, 
  		 pd.product_option_id, pd.add_price, pd.size,
  		 p.product_id, p.name, p.color_name,
  		 s.seller_id, s.seller_name,
  		 f.file_name, f.store_name, f.file_path, f.copyright, f.copyright_url
  	FROM nextjs_shop_stock_hold sh
  	JOIN nextjs_shop_product_option pd ON pd.product_option_id = sh.product_option_id
  	JOIN nextjs_shop_product p ON p.product_id = pd.product_id
  	JOIN nextjs_shop_seller s ON s.seller_id = p.seller_id
  	LEFT JOIN (
        SELECT 
            pi.product_id, 
            pi.file_id
        FROM nextjs_shop_product_image pi
        INNER JOIN (
            SELECT 
                product_id, 
                MIN(sort_key) AS min_sort_key
            FROM nextjs_shop_product_image
            GROUP BY product_id
        ) min_pi 
        ON pi.product_id = min_pi.product_id 
        AND pi.sort_key = min_pi.min_sort_key
    ) tpi ON tpi.product_id = p.product_id
 	LEFT JOIN nextjs_shop_file f ON f.file_id = tpi.file_id
  	WHERE sh.user_id = #{userId} 
    AND sh.status = 'HOLD'
    AND sh.active_hold = 1
    AND sh.expires_at > NOW()
    ORDER BY sh.created_at DESC
  </select>
  
  <!-- 점유상품에 사용가능한 쿠폰조회 -->
  <select id="getAvailableCoupon">
  	SELECT c.*,
  		uc.user_coupon_id, 
		uc.used, 
		uc.user_id
	FROM nextjs_shop_coupon c
	JOIN nextjs_shop_user_coupon uc ON uc.coupon_id = c.coupon_id
	LEFT JOIN nextjs_shop_coupon_allowed ca ON ca.coupon_id = c.coupon_id
	WHERE uc.user_id = #{userId} 
	AND uc.used = 0
	AND (
		ca.product_id IN 
		<foreach collection="productIds" item="id" open="(" separator="," close=")">
	      #{id}
	    </foreach>
	    OR ca.product_id IS NULL
		OR seller_id is NULL
	)
  </select>
  
   <select id="getProductWithCoupons">
  	  SELECT
      sh.hold_id,
      r.count,
      pd.product_option_id,
      IFNULL(pd.add_price, 0)                           AS addPrice,
      uc.user_coupon_id,
      p.product_id,
      p.price,
      c.coupon_id,
      c.description,
      c.discount_type,
      c.discount_value,
      c.max_discount,
      c.minimum_order_before_amount,
      c.is_stackable,
      c.is_product_restricted
  FROM
      (
        <foreach collection="products" item="p" separator=" UNION ALL ">
          SELECT
              #{p.holdId}         AS hold_id,
              #{p.productOptionId} AS product_option_id,
              #{p.count}           AS count,
              #{p.couponId}       AS coupon_id
        </foreach>
      ) AS r
      JOIN nextjs_shop_stock_hold sh ON sh.hold_id = r.hold_id
       AND sh.product_option_id = r.product_option_id
       AND sh.user_id = #{userId}
       AND sh.status = 'HOLD'
       AND sh.active_hold = 1
      JOIN nextjs_shop_product_option pd ON pd.product_option_id = sh.product_option_id
      JOIN nextjs_shop_product p ON p.product_id = pd.product_id
      LEFT JOIN nextjs_shop_coupon c ON c.coupon_id = r.coupon_id
       AND c.status = 'Y'
      LEFT JOIN  nextjs_shop_user_coupon uc ON c.coupon_id = uc.coupon_id AND uc.used = 0
  </select>
  
  <!-- <================================================================================> -->
  
  	<update id="updateUserMileageByBuy">
  		UPDATE nextjs_shop_user
  		SET mileage = mileage - #{usedMileage}
		WHERE user_id = #{userId} AND mileage >= mileage + #{usedMileage} 
  	</update>
  	
  	<select id="getUserMileage">
  		SELECT mileage
  		FROM nextjs_shop_user
  		WHERE user_id = #{userId}
  	</select>
  
	 <insert id="insertOrderGroup">
		INSERT INTO nextjs_shop_order_group (
			user_id, each_coupon_discount_total, common_coupon_discount_total, shipping_fee, 
			used_mileage, remaining_mileage,
			total_price, payment_method, payment_code, status,
			user_coupon_id, address_id
		)
		VALUES (
			#{userId}, #{eachCouponDiscountTotal}, #{commonCouponDiscountTotal}, #{shippingFee}, 
			#{usedMileage}, #{remainingMileage},
			#{totalPrice}, #{paymentMethod}, #{paymentCode}, #{status},
			#{userCouponId}, #{addressId}
		)
	 </insert>
	 
	 <select id="getOrderId">
	 	SELECT order_id
	 	FROM nextjs_shop_order_group
	 	WHERE user_id = #{userId}
	 	ORDER BY order_id DESC
	 	LIMIT 1
	 </select>
  
	 <insert id="insertOrderList">
		INSERT INTO nextjs_shop_order_item
		(order_id, count, order_price, discount_price, final_price, user_coupon_id, hold_id)
		VALUES
		<foreach collection="productList" item="item" separator=",">
			(
				#{orderId},
				#{item.count},
				#{item.price} + #{item.addPrice},
				#{item.discountAmount},
				#{item.finalPrice},
				#{item.userCouponId},
				#{item.holdId}
			)
		</foreach>
	 </insert>
  
	<update id="updateCancelStockHold">
		UPDATE nextjs_shop_stock_hold
		SET status = 'PAY', active_hold = 0
		WHERE hold_id IN
		 <foreach collection="productList" item="item" open="(" separator="," close=")">
		      #{item.holdId}
		 </foreach>
	</update>
	
	<update id="updateProductOptionByBuy">
		UPDATE nextjs_shop_product_option
	  	SET
	    stock = stock - CASE product_option_id
    	<foreach collection="productList" item="item">
      		WHEN #{item.productOptionId} THEN #{item.count}
	    </foreach>
    	ELSE 0 END,
	    sales_count = sales_count + CASE product_option_id
	    <foreach collection="productList" item="item">
	      WHEN #{item.productOptionId} THEN #{item.count}
	    </foreach>
		ELSE 0 END
	  	WHERE product_option_id IN
	  	<foreach collection="productList" item="item" open="(" separator="," close=")">
   		  #{item.productOptionId}
	  	</foreach>
	</update>
	
	<update id="updateUserCouponUsed">
		UPDATE nextjs_shop_user_coupon
		SET used = 1
		WHERE user_coupon_id = #{userCouponId}
		OR user_coupon_id IN
			<foreach collection="productList" item="item" open="(" separator="," close=")">
			      #{item.userCouponId}
			 </foreach>
	</update>
	
	<update id="updateCommonCouponByBuy">
		UPDATE nextjs_shop_coupon c
		JOIN nextjs_shop_user_coupon uc ON c.coupon_id = uc.coupon_id
		SET c.amount = c.amount - 1
		WHERE uc.user_coupon_id = #{userCouponId}
		AND c.amount > 0
	</update>
	<update id="updateEachCouponByBuy">
	  UPDATE nextjs_shop_coupon
	  SET amount = amount - 1
	  WHERE amount > 0 AND
	      coupon_id IN 
      <foreach collection="productList" item="item" open="(" separator="," close=")">
	      #{item.couponId}
	   </foreach>
	</update>

</mapper>
