<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="me._hanho.nextjs_shop.mypage.MypageMapper">
	
	<select id="getUserCoupons">
		SELECT uc.user_coupon_id, uc.used, 
			c.coupon_id, c.description, c.coupon_code, c.discount_type, c.discount_value,
			c.max_discount, c.minimum_order_before_amount, c.is_stackable, c.is_product_restricted,
			c.amount, c.start_date, c.end_date, c.created_at, c.updated_at, 
			s.seller_name
		FROM nextjs_shop_user_coupon uc
		JOIN nextjs_shop_coupon c ON c.coupon_id = uc.coupon_id
		LEFT JOIN nextjs_shop_seller s ON s.seller_no = c.seller_no
		WHERE uc.user_no= #{userNo} AND uc.used = 0
	</select>
	
	<select id="getMyOrderListGroupList">
		<!-- IN 절에 Step A 결과 바인딩 (MyBatis <foreach> 사용)  -->
		SELECT
		    og.order_id, og.order_date,
		    og.each_coupon_discount_total, og.common_coupon_discount_total,
		    og.shipping_fee, og.used_mileage, 
		    og.address_id, og.total_price, og.payment_method, og.status,
		    og.shipping_date, og.return_date
		FROM nextjs_shop_order_group og
		WHERE og.user_no= #{userNo}
		ORDER BY og.order_date DESC, og.order_id DESC
	</select>
	<select id="getMyOrderListProductWithReview">
		SELECT ol.order_list_id, ol.order_id, ol.count, ol.order_price, ol.discount_price,
			ol.final_price AS paidUnitPrice,
			sh.hold_id,
			pd.product_option_id, pd.add_price, pd.size,
			p.product_id, p.name AS productName, p.color_name, p.origin_price, p.final_price,
			s.seller_name,
			ms.menu_sub_id, ms.menu_name AS subMenuName, mt.menu_top_id, mt.menu_name AS topMenuName, mt.gender,
			tpi.product_image_id,
			f.file_id, f.file_name, f.store_name, f.file_extension, f.file_path, f.copyright, f.copyright_url,
			r.review_id, r.content, r.created_at AS reviewDate, r.rating
		FROM nextjs_shop_order_item ol
		JOIN nextjs_shop_stock_hold sh ON sh.hold_id = ol.hold_id
		JOIN nextjs_shop_product_option pd ON pd.product_option_id = sh.product_option_id
		JOIN nextjs_shop_product p ON p.product_id = pd.product_id
		JOIN nextjs_shop_seller s ON s.seller_no = p.seller_no
		JOIN nextjs_shop_menu_sub ms ON ms.menu_sub_id = p.menu_sub_id
		JOIN nextjs_shop_menu_top mt ON mt.menu_top_id = ms.menu_top_id
		LEFT JOIN (
	        SELECT 
	            pi_inner.product_image_id,
	            pi_inner.product_id,
	            pi_inner.file_id
	        FROM nextjs_shop_product_image pi_inner
	        INNER JOIN (
	            SELECT 
	                product_id,
	                MIN(sort_key) AS min_sort_key
	            FROM nextjs_shop_product_image
	            GROUP BY product_id
	        ) first_img
	        ON pi_inner.product_id = first_img.product_id
	        AND pi_inner.sort_key = first_img.min_sort_key
	    ) tpi ON tpi.product_id = p.product_id
	    LEFT JOIN nextjs_shop_file f ON f.file_id = tpi.file_id
		LEFT JOIN nextjs_shop_review r ON r.order_list_id = ol.order_list_id
		WHERE ol.order_id = #{orderId}
	</select>
	<select id="getMyOrderDetail">
		SELECT og.order_id, og.order_date, og.each_coupon_discount_total, 
		og.common_coupon_discount_total, og.shipping_fee, og.used_mileage, 
		og.remaining_mileage, og.total_price, og.payment_method, 
		og.payment_code, og.status, og.shipping_date, og.delivered_date, og.return_date,
		og.user_coupon_id, c.coupon_id, c.description, c.coupon_code, c.discount_type,
		c.discount_value, c.max_discount, c.minimum_order_before_amount, c.is_stackable,
		og.address_id, ua.address_name, ua.recipient_name, ua.address_phone, ua.zonecode,
		ua.address, ua.address_detail, ua.memo, ua.default_address
		FROM nextjs_shop_order_group og
		LEFT JOIN nextjs_shop_user_coupon uc ON uc.user_coupon_id = og.user_coupon_id AND uc.used = 1
		LEFT JOIN nextjs_shop_coupon c ON c.coupon_id = uc.coupon_id
		JOIN nextjs_shop_user_address ua ON ua.address_id = og.address_id
		WHERE og.order_id = #{orderId} AND og.user_no = #{userNo}
	</select>
	<select id="getMyOrderDetailItems">
		SELECT ol.order_list_id, ol.order_id , ol.count, ol.order_price, ol.discount_price, ol.final_price AS paidUnitPrice,
			ol.user_coupon_id, c.coupon_id, c.description, c.coupon_code, c.discount_type,
			c.discount_value, c.max_discount, c.minimum_order_before_amount, c.is_stackable,
			sh.hold_id, pd.product_option_id, pd.add_price, pd.size,
			p.product_id, p.name AS productName, p.color_name, p.origin_price, p.final_price,
			s.seller_name,
			ms.menu_sub_id, ms.menu_name AS subMenuName, mt.menu_top_id, mt.menu_name AS topMenuName,
			tpi.product_image_id,
			f.file_id, f.file_name, f.store_name, f.file_extension, f.file_path, f.copyright, f.copyright_url,
			r.review_id, r.content, r.created_at AS reviewDate, r.rating
		FROM nextjs_shop_order_item ol
		LEFT JOIN nextjs_shop_user_coupon uc ON uc.user_coupon_id = ol.user_coupon_id AND uc.used = 1
		LEFT JOIN nextjs_shop_coupon c ON c.coupon_id = uc.coupon_id
		JOIN nextjs_shop_stock_hold sh ON sh.hold_id = ol.hold_id AND sh.user_no = #{userNo}
		JOIN nextjs_shop_product_option pd ON pd.product_option_id = sh.product_option_id
		JOIN nextjs_shop_product p ON p.product_id = pd.product_id
		JOIN nextjs_shop_seller s ON s.seller_no = p.seller_no
		JOIN nextjs_shop_menu_sub ms ON ms.menu_sub_id = p.menu_sub_id
		JOIN nextjs_shop_menu_top mt ON mt.menu_top_id = ms.menu_top_id
		LEFT JOIN (
	        SELECT 
	            pi_inner.product_image_id,
	            pi_inner.product_id,
	            pi_inner.file_id
	        FROM nextjs_shop_product_image pi_inner
	        INNER JOIN (
	            SELECT 
	                product_id,
	                MIN(sort_key) AS min_sort_key
	            FROM nextjs_shop_product_image
	            GROUP BY product_id
	        ) first_img
	        ON pi_inner.product_id = first_img.product_id
	        AND pi_inner.sort_key = first_img.min_sort_key
	    ) tpi ON tpi.product_id = p.product_id
	    LEFT JOIN nextjs_shop_file f ON f.file_id = tpi.file_id
		LEFT JOIN nextjs_shop_review r ON r.order_list_id = ol.order_list_id
		WHERE ol.order_id = #{orderId}
	</select>

	<insert id="insertReview">
		INSERT INTO nextjs_shop_review (
			content,
			rating,
			order_list_id,
			user_no
		)
		SELECT
			#{review.content},
			#{review.rating},
			oi.order_list_id,
			#{userNo}
		FROM nextjs_shop_order_item oi
		JOIN nextjs_shop_order_group og ON og.order_id = oi.order_id AND og.user_no = #{userNo}
		WHERE oi.order_list_id = #{review.orderListId}
	</insert>
	
	<update id="unselectOutOfStockItems">
	    UPDATE nextjs_shop_cart c
	    JOIN nextjs_shop_product_option pd ON pd.product_option_id = c.product_option_id
	    SET c.selected = 0
	    WHERE c.user_no = #{userNo}
	      AND pd.stock &lt; c.quantity
	</update>
	
	<select id="getCartList">
		SELECT c.cart_id, c.created_at, c.product_option_id,
			pd.add_price, pd.stock, pd.size, p.product_id, 
			p.name AS productName, p.origin_price, p.final_price,
			w.wish_id,
			f.file_id, f.file_name, f.store_name, f.file_path, f.copyright, f.copyright_url,
			s.seller_name,
			c.quantity, c.selected
		FROM nextjs_shop_cart c
		JOIN nextjs_shop_product_option pd ON pd.product_option_id = c.product_option_id
		JOIN nextjs_shop_product p ON p.product_id = pd.product_id
		LEFT JOIN nextjs_shop_wish w ON w.product_id = p.product_id AND w.user_no = c.user_no
		JOIN nextjs_shop_seller s ON s.seller_no = p.seller_no
		LEFT JOIN (
	        SELECT 
	            pi_inner.product_id,
	            pi_inner.file_id
	        FROM nextjs_shop_product_image pi_inner
	        INNER JOIN (
	            SELECT 
	                product_id,
	                MIN(sort_key) AS min_sort_key
	            FROM nextjs_shop_product_image
	            GROUP BY product_id
	        ) first_img
	            ON pi_inner.product_id = first_img.product_id
	           AND pi_inner.sort_key   = first_img.min_sort_key
	    ) tpi ON tpi.product_id = p.product_id
	    LEFT JOIN nextjs_shop_file f ON f.file_id = tpi.file_id
		WHERE c.user_no= #{userNo}
	</select>
	<update id="updateCart">
		UPDATE nextjs_shop_cart
		SET quantity = #{c.quantity}, product_option_id = #{c.productOptionId}
		WHERE cart_id = #{c.cartId} AND user_no = #{userNo}
	</update>
	<update id="updateSelectedCart">
		UPDATE nextjs_shop_cart
		SET selected = #{selected}
		WHERE user_no= #{userNo}
			AND cart_id IN
          <foreach collection="cartIdList" item="cartId" open="(" separator="," close=")">
            #{cartId}
          </foreach>
	</update>
	<delete id="deleteCart">
		DELETE FROM nextjs_shop_cart
		WHERE user_no= #{userNo} 
			AND cart_id IN
          <foreach collection="cartIdList" item="cartId" open="(" separator="," close=")">
            #{cartId}
          </foreach>
	</delete>
	
	<select id="getWishlistItems">
		SELECT w.wish_id, 
			w.created_at,
			p.product_id, 
			p.name, 
			p.origin_price, 
			p.final_price, 
			p.like_count, 
			p.view_count, 
			p.wish_count,
			tpi.product_image_id, 
			f.file_id, 
			f.file_name,  
			f.store_name, 
			f.file_path, 
			f.copyright, 
			f.copyright_url,
			s.seller_name
		FROM nextjs_shop_wish w
		JOIN nextjs_shop_product p ON w.product_id = p.product_id
		JOIN nextjs_shop_seller s ON s.seller_no = p.seller_no
		LEFT JOIN (
	        SELECT 
	            pi_inner.product_image_id,
	            pi_inner.product_id,
	            pi_inner.file_id
	        FROM nextjs_shop_product_image pi_inner
	        INNER JOIN (
	            SELECT 
	                product_id,
	                MIN(sort_key) AS min_sort_key
	            FROM nextjs_shop_product_image
	            GROUP BY product_id
	        ) first_img
	        ON pi_inner.product_id = first_img.product_id
	        AND pi_inner.sort_key = first_img.min_sort_key
	    ) tpi ON tpi.product_id = p.product_id
	    LEFT JOIN nextjs_shop_file f ON f.file_id = tpi.file_id
		WHERE w.user_no= #{userNo}
	</select>
	<select id="getUserAddressList">
		SELECT address_id, address_name, recipient_name, address_phone, zonecode, address, address_detail, memo, default_address, usedate_at
		FROM nextjs_shop_user_address
		WHERE user_no = #{userNo}
		AND is_deleted = 0
		ORDER BY default_address DESC,
			usedate_at DESC,
			updated_at DESC,
			created_at DESC
	</select>
	<insert id="insertUserAddress">
		INSERT INTO nextjs_shop_user_address(address_name, recipient_name, address_phone, zonecode, 
			address, address_detail, memo, default_address, user_no)
		VALUES (
			#{ua.addressName}, #{ua.recipientName}, #{ua.addressPhone}, #{ua.zonecode}, 
			#{ua.address}, #{ua.addressDetail}, #{ua.memo}, #{ua.defaultAddress}, #{userNo}
		)
	</insert>
	<update id="clearDefaultAddress">
		UPDATE nextjs_shop_user_address
		SET default_address = 0
		WHERE default_address = 1 AND address_id != #{addressId} AND user_no= #{userNo}
	</update>
	<update id="updateUserAddress">
		UPDATE nextjs_shop_user_address
		SET address_name = #{ua.addressName}, 
			recipient_name = #{ua.recipientName},
			address_phone = #{ua.addressPhone}, 
			zonecode = #{ua.zonecode},
			address = #{ua.address},
			address_detail = #{ua.addressDetail},
			memo = #{ua.memo},
			default_address = #{ua.defaultAddress},
			updated_at = NOW()
		WHERE address_id = #{ua.addressId} AND user_no= #{userNo}
	</update>
	<select id="isDefaultAddress" resultType="int">
	    SELECT EXISTS (
	        SELECT 1 FROM nextjs_shop_user_address
	        WHERE address_id = #{addressId}
	        	AND user_no = #{userNo}
	        	AND is_deleted = 0
	        	AND default_address = 1
	    ) AS exists_flag
	</select>
	<update id="deleteUserAddress">
		UPDATE nextjs_shop_user_address
		SET is_deleted = 1, default_address = 0
		WHERE address_id = #{addressId} AND user_no = #{userNo}
	</update>
	<update id="updateDefaultLatest">
		UPDATE nextjs_shop_user_address
		SET default_address =
			CASE
				WHEN address_id = (
					SELECT t.address_id
					FROM (
						SELECT address_id
						FROM nextjs_shop_user_address
						WHERE user_no = #{userNo}
						  AND is_deleted = 0
						ORDER BY updated_at DESC, address_id DESC
						LIMIT 1
					) t
				) THEN 1
				ELSE 0
			END
		WHERE user_no = #{userNo}
		  AND is_deleted = 0
	</update>

</mapper>
