<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="me._hanho.nextjs_shop.product.ProductMapper">
	<select id="getProductList">
	  SELECT
	    p.product_id,
	    p.name,
	    p.color_name,
	    p.origin_price,
	    p.final_price,
	    p.created_at,
	    p.view_count,
	    p.wish_count,
	    s.seller_name
	  FROM nextjs_shop_product p
	  JOIN nextjs_shop_seller s ON s.seller_no = p.seller_no
	  WHERE p.sale_stop = 0
	    AND p.menu_sub_id = #{menuSubId}
	  <choose>
	    <!-- 최신순 -->
	    <when test="sort == 'latest'">
	      <if test="lastCreatedAt != null and lastProductId != null">
	        AND (p.created_at, p.product_id) &lt; (#{lastCreatedAt}, #{lastProductId})
	      </if>
	      ORDER BY p.created_at DESC, p.product_id DESC
	    </when>
	
	    <!-- 인기순 (view+wish) -->
	    <when test="sort == 'popular'">
	      <if test="lastPopularity != null and lastCreatedAt != null and lastProductId != null">
	        AND (
	          (p.view_count + p.wish_count) &lt; #{lastPopularity}
	          OR (
	            (p.view_count + p.wish_count) = #{lastPopularity}
	            AND (p.created_at, p.product_id) &lt; (#{lastCreatedAt}, #{lastProductId})
	          )
	        )
	      </if>
	      ORDER BY (p.view_count + p.wish_count) DESC,
	               p.created_at DESC,
	               p.product_id DESC
	    </when>
	
	    <!-- 기본(안전망) -->
	    <otherwise>
	      ORDER BY p.product_id DESC
	    </otherwise>
	  </choose>
	
	  LIMIT 30
	</select>
	
	<select id="getProductImageListByProductIds" parameterType="list" resultType="ProductImageFile">
	  SELECT
	    pi.product_id,
	    f.file_id,
	    f.file_name,
	    f.store_name,
	    f.file_path,
	    f.copyright,
	    f.copyright_url
	  FROM nextjs_shop_product_image pi
	  JOIN nextjs_shop_file f ON pi.file_id = f.file_id
	  WHERE pi.product_id IN
	  <foreach collection="list" item="id" open="(" separator="," close=")">
	    #{id}
	  </foreach>
	  ORDER BY pi.product_id ASC, pi.sort_key ASC
	</select>

	<select id="isLikeExist" resultType="boolean">
		SELECT EXISTS (
        SELECT 1
        FROM nextjs_shop_like
        WHERE product_id = #{productId}
          AND user_no = #{userNo}
	    )
	</select>
	<update id="upProductLike">
		UPDATE nextjs_shop_product
		SET like_count = like_count + 1
		WHERE product_id = #{productId} 
	</update>
	<insert id="insertLike">
		INSERT INTO nextjs_shop_like(product_id, user_no)
		VALUES(#{productId}, #{userNo})
	</insert>
	<update id="downProductLike">
		UPDATE nextjs_shop_product
		SET like_count = like_count - 1
		WHERE product_id = #{productId}
	</update>
	<delete id="deleteLike">
		DELETE FROM nextjs_shop_like
		WHERE product_id = #{productId}
          AND user_no = #{userNo}
	</delete>
	<!--  -->
	<select id="isWishExist" resultType="boolean">
		SELECT EXISTS (
        SELECT 1
        FROM nextjs_shop_wish
        WHERE product_id = #{productId}
          AND user_no = #{userNo}
	    )
	</select>
	<update id="upProductWish">
		UPDATE nextjs_shop_product
		SET wish_count = wish_count + 1
		WHERE product_id = #{productId} 
	</update>
	<insert id="insertWish">
		INSERT INTO nextjs_shop_wish(product_id, user_no)
		VALUES(#{productId}, #{userNo})
	</insert>
	<update id="downProductWish">
		UPDATE nextjs_shop_product
		SET wish_count = wish_count - 1
		WHERE product_id = #{productId}
	</update>
	<delete id="deleteWish">
		DELETE FROM nextjs_shop_wish
		WHERE product_id = #{productId}
          AND user_no = #{userNo}
	</delete>
	<!--  -->

	<select id="getProductCart">
		SELECT product_option_id
		FROM nextjs_shop_cart
		WHERE product_option_id IN (
		    SELECT product_option_id
		    FROM nextjs_shop_product_option
		    WHERE product_id = #{productId}
		)
		AND user_no = #{userNo}
	</select>

	<select id="getCartQtyMap" resultType="me._hanho.nextjs_shop.product.CartQtyRow">
		SELECT
			c.product_option_id AS productOptionId,
			c.quantity AS quantity
		FROM nextjs_shop_cart c
		WHERE c.user_no = #{userNo}
			AND c.product_option_id IN
			<foreach collection="cartList" item="item" open="(" separator="," close=")">
			#{item.productOptionId}
			</foreach>
	</select>
	
	<update id="upQuantityCart">
		UPDATE nextjs_shop_cart c
		JOIN nextjs_shop_product_option po ON c.product_option_id = po.product_option_id
		SET c.quantity = LEAST(
			c.quantity + CASE c.product_option_id
				<foreach collection="updateList" item="item">
				WHEN #{item.productOptionId} THEN #{item.quantity}
				</foreach>
				ELSE 0
			END,
			po.stock
		)
		WHERE c.user_no = #{userNo}
			AND c.product_option_id IN
			<foreach collection="updateList" item="item" open="(" separator="," close=")">
			#{item.productOptionId}
			</foreach>
	</update>

	<insert id="addCart">
		INSERT INTO nextjs_shop_cart (product_option_id, user_no, quantity)
		SELECT t.product_option_id, #{userNo}, LEAST(t.quantity, po.stock) AS quantity
		FROM (
			<foreach collection="insertList" item="item" separator=" UNION ALL ">
			SELECT #{item.productOptionId} AS product_option_id, #{item.quantity} AS quantity
			</foreach>
		) t
		JOIN nextjs_shop_product_option po ON po.product_option_id = t.product_option_id
		WHERE po.stock > 0
	</insert>

	<select id="getCartAppliedResult" resultType="me._hanho.nextjs_shop.product.CartAppliedRow">
		SELECT
			t.product_option_id AS productOptionId,
			t.quantity AS requestedQuantity,
			po.stock AS stock,
			c.quantity AS cartQuantity
		FROM (
			<foreach collection="cartList" item="item" separator=" UNION ALL ">
				SELECT
					#{item.productOptionId} AS product_option_id,
					#{item.quantity} AS quantity
			</foreach>
		) t
		JOIN nextjs_shop_product_option po
			ON po.product_option_id = t.product_option_id
		LEFT JOIN nextjs_shop_cart c
			ON c.user_no = #{userNo}
			AND c.product_option_id = t.product_option_id
	</select>

	<select id="getProductDetail">
		SELECT  p.product_id, p.name, p.color_name, p.origin_price, p.final_price, p.created_at, 
		p.like_count, p.view_count, p.wish_count, 
		s.seller_name, s.base_shipping_fee, s.free_shipping_min_amount, s.extra_shipping_fee,
		p.menu_sub_id, ms.menu_name AS subMenuName, mt.menu_name AS topMenuName, mt.gender,
		p.material_info, p.manufacturer_name, p.country_of_origin, 
		p.wash_care_info, p.manufactured_ym, p.quality_guarantee_info, 
		p.after_service_contact, p.after_service_manager, p.after_service_phone,
		p.shipping_type, p.shipping_due_date, p.shipping_note
		FROM nextjs_shop_product p
		JOIN nextjs_shop_seller s ON s.seller_no = p.seller_no
		JOIN nextjs_shop_menu_sub ms ON ms.menu_sub_id = p.menu_sub_id
		JOIN nextjs_shop_menu_top mt ON mt.menu_top_id = ms.menu_top_id
		WHERE sale_stop = 0 AND product_id = #{productId}
	</select>
	<select id="getProductImageList">
		SELECT
		    pi.product_id,
		    f.file_id,
		    f.file_name,
		    f.store_name,
		    f.file_path,
		    f.copyright,
		    f.copyright_url
		FROM nextjs_shop_product_image pi
		JOIN nextjs_shop_file f ON pi.file_id = f.file_id
		WHERE product_id = #{productId}
		ORDER BY pi.product_id ASC, pi.sort_key ASC
	</select>
	<select id="getProductOptionList">
		SELECT product_option_id, product_id, add_price, stock, size
		FROM nextjs_shop_product_option
		WHERE product_id = #{productId} AND is_displayed = 1
	</select>
	<select id="getAvailableProductCoupon">
	    SELECT
	        c.coupon_id, c.description, c.discount_type, c.discount_value,
	        c.max_discount, c.minimum_order_before_amount, c.status,
	        c.is_stackable, c.is_product_restricted,
	        c.amount, c.start_date, c.end_date, c.issue_method,
	        <!-- c.seller_no, c.admin_no, 관리자 확인용 나중에 주석처리하기 -->
	        ca.coupon_allowed_id,
	        uc.user_coupon_id,
	        s.seller_name
	    FROM nextjs_shop_product p
	    JOIN nextjs_shop_coupon c ON (c.seller_no = p.seller_no OR (c.seller_no IS NULL AND c.admin_no IS NOT NULL))
	    LEFT JOIN nextjs_shop_coupon_allowed ca ON ca.coupon_id = c.coupon_id AND ca.product_id = p.product_id
	    LEFT JOIN nextjs_shop_user_coupon uc ON uc.coupon_id = c.coupon_id AND uc.user_no = #{userNo} AND uc.used = 0
	    LEFT JOIN nextjs_shop_seller s ON c.seller_no = s.seller_no
	    WHERE p.product_id = #{productId}
	        AND c.is_deleted = 0 AND c.status = 'ACTIVE' AND c.amount > 0
	        <!-- AND NOW() BETWEEN c.start_date AND c.end_date 포폴용 주석 -->
	        AND (
	            c.is_product_restricted = 0
	            OR ca.product_id IS NOT NULL
	        )
	        AND (
	            c.issue_method = 'CLAIM'
	            OR (c.issue_method IN ('MANUAL','AUTO') AND uc.user_coupon_id IS NOT NULL)
	        )
	</select>
	
	<insert id="couponDownload">
		INSERT INTO nextjs_shop_user_coupon(user_no, coupon_id)
		VALUES(#{userNo}, #{couponId})
	</insert>

	<select id="getProductReviewList">
		SELECT r.review_id, r.content, r.created_at AS reviewDate, r.rating, r.order_list_id, 
			r.user_no, u.name AS userName
		FROM nextjs_shop_review r
		JOIN nextjs_shop_user u ON r.user_no = u.user_no
		JOIN nextjs_shop_order_item oi ON r.order_list_id = oi.order_list_id
		JOIN nextjs_shop_stock_hold sh ON oi.hold_id = sh.hold_id
		JOIN nextjs_shop_product_option po ON sh.product_option_id = po.product_option_id
		WHERE po.product_id = #{productId} AND u.withdrawal_status = 'ACTIVE'
		ORDER BY
		<if test="userNo != null">
			CASE WHEN r.user_no = #{userNo} THEN 0 ELSE 1 END ASC,
		</if>
		r.created_at DESC,
		r.review_id DESC
	</select>
	<select id="getProductReviewSummary">
		SELECT
		    AVG(rating) AS avg_rating,
		    COUNT(*) AS review_count
		FROM nextjs_shop_review r
		JOIN nextjs_shop_order_item oi ON r.order_list_id = oi.order_list_id
		JOIN nextjs_shop_stock_hold sh ON oi.hold_id = sh.hold_id
		JOIN nextjs_shop_product_option po ON sh.product_option_id = po.product_option_id
		WHERE po.product_id = #{productId}
	</select>
	<select id="getProductQnaList">
		SELECT
			pq.product_qna_id,
			pq.question,
			pq.created_at,
			pq.answer,
			pq.res_created_at,
			pq.secret,
			pq.product_qna_type_id,
			pqt.name AS productQnaTypeName,
			pq.product_id,
			pq.user_no,
			u.name AS userName
		FROM nextjs_shop_product_qna pq
		JOIN nextjs_shop_user u ON pq.user_no = u.user_no
		JOIN nextjs_shop_product_qna_type pqt ON pq.product_qna_type_id = pqt.product_qna_type_id
		WHERE pq.product_id = #{productId} AND u.withdrawal_status = 'ACTIVE'
		ORDER BY
		<if test="userNo != null">
			CASE WHEN pq.user_no = #{userNo} THEN 0 ELSE 1 END ASC,
		</if>
		pq.created_at DESC,
		pq.product_qna_id DESC
	</select>
	
</mapper>
