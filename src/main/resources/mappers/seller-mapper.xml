<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="me._hanho.nextjs_shop.seller.SellerMapper">

	<select id="isSeller">
		SELECT seller_id, password
		FROM nextjs_shop_seller
		WHERE seller_id = #{sellerId} AND approval_status = 'APPROVED'
	</select>
	<insert id="insertToken">
		INSERT INTO nextjs_shop_token(connect_ip, connect_agent, refresh_token, seller_id)
		VALUES(#{connectIp}, #{connectAgent}, #{refreshToken}, #{sellerId})
	</insert>
	<select id="getSeller">
		SELECT seller_id,seller_name,seller_name_en,extension_number,mobile_number,email,
		business_registration_number,telecom_sales_number,representative_name,
		business_zipcode,business_address,business_address_detail,
		updated_at,requested_at,approval_status,approved_at
		FROM nextjs_shop_seller
		WHERE seller_id = #{sellerId}
	</select>
	<insert id="setSeller">
		INSERT INTO nextjs_shop_seller(seller_id,password,seller_name,seller_name_en,extension_number,mobile_number,email,
			business_registration_number,telecom_sales_number,representative_name,business_zipcode,business_address,business_address_detail,
			approval_status)
		VALUES(#{sellerId},#{password},#{sellerName},#{sellerNameEn},#{extensionNumber},#{mobileNumber},#{email},
			#{businessRegistrationNumber},#{telecomSalesNumber},#{representativeName},
			#{businessZipcode},#{businessAddress},#{businessAddressDetail}, 'PENDING')
	</insert>

	<select id="getSellerProductList">
		SELECT p.product_id, p.name, p.color_name, p.price, p.created_at, p.view_count, p.wish_count, p.seller_id,
			ms.menu_name AS subMenuName, mt.menu_name AS topMenuName, mt.gender
		FROM nextjs_shop_product p
		JOIN nextjs_shop_menu_sub ms ON p.menu_sub_id = ms.menu_sub_id
		JOIN nextjs_shop_menu_top mt ON mt.menu_top_id = ms.menu_top_id
		WHERE p.seller_id = #{sellerId}
	</select>
	<select id="selectDetailsByProductIds">
		SELECT product_option_id, product_id, add_price, stock, created_at, size, sales_count
		FROM nextjs_shop_product_option
		WHERE product_id IN
		<foreach collection="ids" item="id" open="(" close=")" separator=",">
			#{id}
		</foreach>
		ORDER BY product_id, size
	</select>
	<insert id="addProduct">
		INSERT INTO nextjs_shop_product(name, color_name, price, seller_id, menu_sub_id)
		VALUES(#{name}, #{colorName}, #{price}, #{sellerId}, #{menuSubId})
	</insert>
	<update id="updateProduct">
		UPDATE nextjs_shop_product
		SET name = #{name}, color_name = #{colorName}, price = #{price}, sale_stop = #{saleStop}, menu_sub_id = #{menuSubId}
		WHERE product_id = #{productId}
	</update>
	<insert id="addProductOption">
		INSERT INTO nextjs_shop_product_option(product_id, add_price, stock, size)
		VALUES(#{productId}, #{addPrice}, #{stock}, #{size})
	</insert>
	<update id="updateProductOption">
		UPDATE nextjs_shop_product_option
		SET add_price = #{addPrice}, stock = #{stock}
		WHERE product_option_id = #{productOptionId}
	</update>
	<select id="getSellerCouponList">
		SELECT *
		FROM nextjs_shop_coupon
		WHERE seller_id = #{sellerId} OR seller_id IS NULL
	</select>
	<insert id="addCoupon">
    	INSERT INTO nextjs_shop_coupon(description, coupon_code, discount_type, discount_value, max_discount,
        	minimum_order_before_amount, status, is_stackable, is_product_restricted, amount, start_date, end_date, seller_id)
    	VALUES(#{description}, #{couponCode}, #{discountType}, #{discountValue}, #{maxDiscount},
	        #{minimumOrderBeforeAmount}, #{status}, #{isStackable}, #{isProductRestricted}, #{amount}, #{startDate},
	        #{endDate}, #{sellerId})
	</insert>
	<update id="updateCouponStatus">
		UPDATE nextjs_shop_coupon
		SET status = #{status}
		WHERE coupon_id = #{couponId}
	</update>
	<select id="getSellerCouponAllow">
		SELECT ca.coupon_allowed_id, ca.coupon_id, ca.product_id, p.name, p.created_at
		FROM nextjs_shop_coupon_allowed ca
		JOIN nextjs_shop_product p ON p.product_id = ca.product_id
		WHERE coupon_id = #{couponId}
	</select>
	<delete id="deleteAllsellerCouponAllow">
		DELETE FROM nextjs_shop_coupon_allowed
		WHERE coupon_id = #{couponId}
	</delete>
	<insert id="insertSellerCouponAllowList">
	    INSERT INTO nextjs_shop_coupon_allowed (coupon_id, product_id)
	    VALUES
	    <foreach collection="productIds" item="pid" separator=",">
	        (#{couponId}, #{pid})
	    </foreach>
	</insert>
	<insert id="issueCouponsToUsers">
		INSERT INTO nextjs_shop_user_coupon (user_id, coupon_id)
		VALUES 
 		<foreach collection="userIds" item="uid" separator=",">
			(#{uid}, #{couponId})
		</foreach>
	</insert>
	<select id="getProductViewCountList">
	    SELECT pv.user_id, u.name AS user_name, pv.product_id,
			p.name AS productName,
			COUNT(*) AS viewCount,
			MAX(pv.view_date) AS latestDate
	    FROM nextjs_shop_product_view pv
    	JOIN nextjs_shop_product p ON p.product_id = pv.product_id
	    JOIN nextjs_shop_user u ON u.user_id = pv.user_id
	    WHERE p.seller_id = #{sellerId}
	    GROUP BY pv.user_id, pv.product_id, u.name, p.name
	    ORDER BY pv.view_date DESC, view_count DESC
	</select>
	<select id="getProductWishCountList">
		SELECT MAX(w.created_at) AS latestDate, w.user_id, u.name AS userName,
			GROUP_CONCAT(p.name ORDER BY w.created_at DESC SEPARATOR ',') AS productNames
		FROM nextjs_shop_wish w
		JOIN nextjs_shop_product p ON p.product_id = w.product_id
		JOIN nextjs_shop_user u    ON u.user_id = w.user_id
		WHERE p.seller_id = #{sellerId}
		GROUP BY w.user_id, u.name
		ORDER BY w.created_at DESC
	</select>
	<select id="getBrandBookmarkList">
		SELECT bb.created_at, bb.user_id, u.name AS userName
		FROM nextjs_shop_brand_bookmark bb
		JOIN nextjs_shop_user u ON u.user_id = bb.user_id
		WHERE seller_id = #{sellerId}
		ORDER BY bb.created_at DESC
	</select>
	<select id="getUserInCartCountList">
		SELECT
			MAX(c.created_at) AS latestDate, COUNT(*) AS inCartCount, c.user_id, u.name AS userName,
			GROUP_CONCAT(DISTINCT p.name ORDER BY c.created_at DESC SEPARATOR ',') AS productNames
	    FROM nextjs_shop_cart c
	    JOIN nextjs_shop_product_option d ON d.product_option_id = c.product_option_id
	    JOIN nextjs_shop_product p        ON p.product_id = d.product_id
	    JOIN nextjs_shop_user u           ON u.user_id = c.user_id
	    WHERE p.seller_id = #{sellerId}
	    GROUP BY c.user_id, u.name
	    ORDER BY c.created_at DESC
	</select>
	
</mapper>
