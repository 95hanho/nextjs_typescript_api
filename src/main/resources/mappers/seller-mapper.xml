<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="me._hanho.nextjs_shop.seller.SellerMapper">

	<!-- 로그인 관련 -->
	<select id="isSeller">
		SELECT seller_no, seller_id, password
		FROM nextjs_shop_seller
		WHERE seller_id = #{sellerId} AND approval_status = 'APPROVED'
	</select>
	<insert id="insertToken">
		INSERT INTO nextjs_shop_token(connect_ip, connect_agent, refresh_token, seller_no)
		VALUES(#{t.connectIp}, #{t.connectAgent}, #{t.refreshToken}, #{sellerNo})
	</insert>
	<select id="getSellerNoByToken">
		SELECT s.seller_no
		FROM nextjs_shop_token t
		JOIN nextjs_shop_seller s ON t.seller_no = s.seller_no 
		WHERE refresh_token = #{refreshToken} AND connect_ip = #{connectIp} AND connect_agent = #{connectAgent}
		ORDER BY created_at DESC, token_id DESC
		LIMIT 1
	</select>
	<select id="getSeller">
		SELECT seller_name,
			seller_name_en,
			extension_number,
			mobile_number,
			email,
			business_registration_number,
			telecom_sales_number,
			representative_name,
			business_zipcode,
			business_address,
			business_address_detail
		FROM nextjs_shop_seller
		WHERE seller_no = #{sellerNo}
	</select>
	<select id="hasId" resultType="int">
	    SELECT EXISTS (
	        SELECT 1 FROM nextjs_shop_seller
	        WHERE seller_id = #{sellerId}
	    ) AS exists_flag
	</select>
	<insert id="setSeller">
		INSERT INTO nextjs_shop_seller(seller_id,password,seller_name,seller_name_en,extension_number,mobile_number,email,
			business_registration_number,telecom_sales_number,representative_name,business_zipcode,business_address,business_address_detail,
			approval_status)
		VALUES(#{sellerId},#{password},#{sellerName},#{sellerNameEn},#{extensionNumber},#{mobileNumber},#{email},
			#{businessRegistrationNumber},#{telecomSalesNumber},#{representativeName},
			#{businessZipcode},#{businessAddress},#{businessAddressDetail}, 'PENDING')
	</insert>
	<!-- 제품 관련 -->
	<select id="getSellerProductList">
		SELECT p.product_id, p.name, p.color_name, p.origin_price, p.final_price, p.created_at, 
			p.like_count, p.view_count, p.wish_count, p.sale_stop,
			p.menu_sub_id, ms.menu_name AS subMenuName, mt.menu_name AS topMenuName, mt.gender,
			p.material_info, p.manufacturer_name, p.country_of_origin, p.wash_care_info, p.manufactured_ym, 
			p.quality_guarantee_info, p.after_service_contact, p.after_service_manager, p.after_service_phone
		FROM nextjs_shop_product p
		JOIN nextjs_shop_menu_sub ms ON p.menu_sub_id = ms.menu_sub_id
		JOIN nextjs_shop_menu_top mt ON mt.menu_top_id = ms.menu_top_id
		WHERE p.seller_no = #{sellerNo}
	</select>
	<select id="selectDetailsByProductIds">
		SELECT product_option_id, product_id, add_price, stock, created_at, size, sales_count
		FROM nextjs_shop_product_option
		WHERE product_id IN
		<foreach collection="ids" item="id" open="(" close=")" separator=",">
			#{id}
		</foreach>
		ORDER BY product_id, size
	</select>
	<insert id="addProduct">
		INSERT INTO nextjs_shop_product(name, color_name, origin_price, final_price, seller_no, menu_sub_id, material_info, manufacturer_name, 
		country_of_origin, wash_care_info, manufactured_ym, quality_guarantee_info, 
		after_service_contact, after_service_manager, after_service_phone)
		VALUES(#{p.name}, #{p.colorName}, #{p.originPrice}, #{p.finalPrice}, #{sellerNo}, #{p.menuSubId}, 
			#{p.materialInfo}, #{p.manufacturerName}, #{p.countryOfOrigin}, #{p.washCareInfo}, #{p.manufacturedYm}, #{p.qualityGuaranteeInfo}, 
			#{p.afterServiceContact}, #{p.afterServiceManager}, #{p.afterServicePhone})
	</insert>
	<update id="updateProduct">
		UPDATE nextjs_shop_product
		SET name = #{p.name}, color_name = #{p.colorName}, origin_price = #{p.originPrice}, final_price = #{p.finalPrice}, 
		sale_stop = #{p.saleStop}, menu_sub_id = #{p.menuSubId},
		material_info = #{p.materialInfo}, manufacturer_name = #{p.manufacturerName}, country_of_origin = #{p.countryOfOrigin}, 
		wash_care_info = #{p.washCareInfo}, manufactured_ym = #{p.manufacturedYm}, quality_guarantee_info = #{p.qualityGuaranteeInfo},
		after_service_contact = #{p.afterServiceContact}, after_service_manager = #{p.afterServiceManager}, after_service_phone = #{p.afterServicePhone}
		WHERE product_id = #{p.productId} AND seller_no = #{sellerNo}
	</update>
	<insert id="addProductOption">
		INSERT INTO nextjs_shop_product_option (
			product_id,
			add_price,
			stock,
			size
		)
		SELECT
			#{po.productId},
			#{po.addPrice},
			#{po.stock},
			#{po.size}
		FROM nextjs_shop_product p
		WHERE p.product_id = #{po.productId}
		  AND p.seller_no = #{sellerNo}
	</insert>
	<update id="updateProductOption">
		UPDATE nextjs_shop_product_option po
		JOIN nextjs_shop_product p ON p.product_id = po.product_id
		SET po.add_price = #{po.addPrice}, po.stock = #{po.stock}, po.is_displayed = #{po.isDisplayed}
		WHERE po.product_option_id = #{po.productOptionId} AND p.seller_no = #{sellerNo}
	</update>
	<delete id="deleteProductOption">
	    DELETE po
	    FROM nextjs_shop_product_option po
	    JOIN nextjs_shop_product p 
      		ON p.product_id = po.product_id
	    WHERE po.product_option_id = #{productOptionId}
      		AND p.seller_no = #{sellerNo}
	</delete>
	<select id="getSellerCouponList">
		SELECT coupon_id, description, coupon_code, 
			discount_type, discount_value, max_discount, minimum_order_before_amount, 
			status, is_stackable, is_product_restricted, amount, start_date, end_date, 
			created_at, updated_at
		FROM nextjs_shop_coupon
		WHERE seller_no = #{sellerNo} AND is_deleted = 0
		ORDER BY updated_at DESC, created_at DESC
	</select>
	<select id="countByCouponCode" resultType="int">
	    SELECT COUNT(1)
	    FROM nextjs_shop_coupon
	    WHERE coupon_code = #{couponCode}
	</select>
	<insert id="addCoupon">
    	INSERT INTO nextjs_shop_coupon(description, coupon_code, discount_type, discount_value, max_discount,
        	minimum_order_before_amount, amount, start_date, end_date, seller_no)
    	VALUES(#{c.description}, #{c.couponCode}, #{c.discountType}, #{c.discountValue}, #{c.maxDiscount},
	        #{c.minimumOrderBeforeAmount}, #{c.amount}, #{c.startDate}, #{c.endDate}, #{sellerNo})
	</insert>
	<update id="updateCoupon">
		UPDATE nextjs_shop_coupon
		SET description = #{c.description}, discount_value = #{c.discountValue}, max_discount = #{c.maxDiscount}, 
			minimum_order_before_amount = #{c.minimumOrderBeforeAmount}, status = #{c.status},
			is_stackable = #{c.isStackable}, is_product_restricted = #{c.isProductRestricted}, amount = #{c.amount}, 
			start_date = #{c.startDate}, end_date = #{c.endDate}
		WHERE coupon_id = #{c.couponId} AND seller_no = #{sellerNo}
	</update>
	<update id="deleteCoupon">
		UPDATE nextjs_shop_coupon
		SET is_deleted = 1
		WHERE coupon_id = #{couponId} AND seller_no = #{sellerNo}
	</update>
	<select id="getSellerCouponAllow">
	    SELECT
	        p.product_id,
	        p.name AS productName,
	        ca.coupon_allowed_id,
	        ca.coupon_id
	    FROM nextjs_shop_product p
	    LEFT JOIN nextjs_shop_coupon_allowed ca
	        ON p.product_id = ca.product_id
	       AND ca.coupon_id = #{couponId}
	    WHERE p.seller_no = #{sellerNo}
	    ORDER BY
	        CASE
	            WHEN ca.coupon_id IS NOT NULL THEN 0
	            ELSE 1
	        END ASC,
	        ca.coupon_allowed_id DESC,
	        p.updated_at DESC,
	        p.created_at DESC
	</select>
	<insert id="insertSellerCouponAllowList">
	    INSERT IGNORE INTO nextjs_shop_coupon_allowed (coupon_id, product_id)
	    SELECT
	        c.coupon_id,
	        p.product_id
	    FROM nextjs_shop_coupon c
	    JOIN nextjs_shop_product p
	      ON p.seller_no = c.seller_no
	    WHERE c.coupon_id = #{couponId}
	      AND c.seller_no = #{sellerNo}
	      AND p.product_id IN
	      <foreach collection="productIds" item="pid" open="(" close=")" separator=",">
	          #{pid}
	      </foreach>
	</insert>
	<delete id="deleteSellerCouponAllowList">
	    DELETE ca
	    FROM nextjs_shop_coupon_allowed ca
	    JOIN nextjs_shop_coupon c ON c.coupon_id = ca.coupon_id
	    JOIN nextjs_shop_product p ON p.product_id = ca.product_id
	    WHERE ca.coupon_id = #{couponId}
	      AND c.seller_no = #{sellerNo}
	      AND p.seller_no = #{sellerNo}
	      AND ca.product_id IN
	      <foreach collection="productIds" item="pid" open="(" close=")" separator=",">
	          #{pid}
	      </foreach>
	</delete>
	<select id="getProductViewCountList">
	    SELECT pv.user_id, u.name AS user_name, pv.product_id,
			p.name AS productName,
			COUNT(*) AS viewCount,
			MAX(pv.view_date) AS latestDate
	    FROM nextjs_shop_product_view pv
    	JOIN nextjs_shop_product p ON p.product_id = pv.product_id
	    JOIN nextjs_shop_user u ON u.user_id = pv.user_id
	    WHERE p.seller_no = #{sellerNo}
	    GROUP BY pv.user_id, pv.product_id, u.name, p.name
	    ORDER BY pv.view_date DESC, view_count DESC
	</select>
	<select id="getProductWishCountList">
		SELECT MAX(w.created_at) AS latestDate, w.user_id, u.name AS userName,
			GROUP_CONCAT(p.name ORDER BY w.created_at DESC SEPARATOR ',') AS productNames
		FROM nextjs_shop_wish w
		JOIN nextjs_shop_product p ON p.product_id = w.product_id
		JOIN nextjs_shop_user u    ON u.user_id = w.user_id
		WHERE p.seller_no = #{sellerNo}
		GROUP BY w.user_id, u.name
		ORDER BY w.created_at DESC
	</select>
	<select id="getBrandBookmarkList">
		SELECT bb.created_at, bb.user_id, u.name AS userName
		FROM nextjs_shop_brand_bookmark bb
		JOIN nextjs_shop_user u ON u.user_id = bb.user_id
		WHERE seller_no = #{sellerNo}
		ORDER BY bb.created_at DESC
	</select>
	<select id="getUserInCartCountList">
		SELECT
			MAX(c.created_at) AS latestDate, COUNT(*) AS inCartCount, c.user_id, u.name AS userName,
			GROUP_CONCAT(DISTINCT p.name ORDER BY c.created_at DESC SEPARATOR ',') AS productNames
	    FROM nextjs_shop_cart c
	    JOIN nextjs_shop_product_option d ON d.product_option_id = c.product_option_id
	    JOIN nextjs_shop_product p        ON p.product_id = d.product_id
	    JOIN nextjs_shop_user u           ON u.user_id = c.user_id
	    WHERE p.seller_no = #{sellerNo}
	    GROUP BY c.user_id, u.name
	    ORDER BY c.created_at DESC
	</select>
	
</mapper>
